(function(f){function b(h,g){this.options=g;this.$tree=f(h);this.language=this.options.languages[this.options.language]===undefined?this.options.languages.en:f.extend({},this.options.languages.en,this.options.languages[this.options.language]);this._isNodeDragging=false;this._lastId=0;if(this.options.cache>0){this.cacheManager=new e(this)}var j=this.language;if(this.options.template===undefined){var i='<table class="table gtreetable"><tr class="'+this.options.classes.node+" "+this.options.classes.collapsed+'"><td><span>';if(this.options.draggable===true){i+='<span class="'+this.options.classes.handleIcon+'">&zwnj;</span><span class="'+this.options.classes.draggablePointer+'">&zwnj;</span>'}i+='<span class="'+this.options.classes.indent+'">&zwnj;</span><span class="'+this.options.classes.ceIcon+' icon"></span><span class="'+this.options.classes.selectedIcon+' icon"></span><span class="'+this.options.classes.typeIcon+'"></span><span class="'+this.options.classes.name+'"></span></span><span class="hide '+this.options.classes.action+'"><input type="text" name="name" value="" style="width: '+this.options.inputWidth+'" class="form-control" /><button type="button" class="btn btn-sm btn-primary '+this.options.classes.saveButton+'">'+j.save+'</button> <button type="button" class="btn btn-sm '+this.options.classes.cancelButton+'">'+j.cancel+'</button></span><div class="btn-group pull-right"><button type="button" class="btn btn-sm btn-default dropdown-toggle node-actions" data-toggle="dropdown">'+j.action+' <span class="caret"></span></button><ul class="dropdown-menu" role="menu"><li role="presentation" class="dropdown-header">'+j.action+"</li>";this.actions=[];if(this.options.defaultActions!==null){this.actions=this.options.defaultActions}if(this.options.actions!==undefined){this.actions.push.apply(this.actions,this.options.actions)}f.each(this.actions,function(l,n){if(n.divider===true){i+='<li class="divider"></li>'}else{var m=n.name.match(/\{([\w\W]+)\}/),k=m!==null&&m[1]!==undefined&&j.actions[m[1]]!==undefined?j.actions[m[1]]:n.name;i+='<li role="presentation"><a href="#notarget" class="node-action-'+l+'" tabindex="-1">'+k+"</a></li>"}});i+="</ul></div></td></tr></table>";this.options.template=i}if(this.$tree.find("tbody").length===0){this.$tree.append("<tbody></tbody>")}if(!this.options.readonly){this.$tree.addClass("gtreetable-fullAccess")}this.$nodeTemplate=f(this.options.templateSelector!==undefined?this.options.templateSelector:this.options.template).find("."+this.options.classes.node);if(this.options.draggable===true){this.isNodeDragging(false)}this.init()}b.prototype.VERSION="2.0a";b.prototype={getNode:function(g){return g.data("bs.gtreetable.gtreetablenode")},getNodeById:function(g){return this.getNode(this.$tree.find("."+this.options.classes.node+"[data-id='"+g+"']"))},getSelectedNodes:function(){var h=[],g=this;f.each(this.$tree.find("."+this.options.classes.selected),function(){h.push(g.getNode(f(this)))});return h},getSourceNodes:function(l,j){var h=this,k=this.getNodeById(l),g=l>0&&this.options.cache>0;if(g&&j!==true){var i=this.cacheManager.get(k);if(i!==undefined){return i}}return f.ajax({type:"GET",url:h.options.source(l),dataType:"json",beforeSend:function(){if(l>0){k.isLoading(true)}},success:function(n){for(var m=0;m<n.length;m+=1){n[m].parent=l}if(typeof h.options.sort==="function"){n.sort(h.options.sort)}if(g){h.cacheManager.set(k,n)}},error:function(m){alert(m.status+": "+m.responseText)},complete:function(){if(l>0){k.isLoading(false)}}})},init:function(){var g=this;this.getSourceNodes(0).done(function(j){for(var h in j){var i=new c(j[h],g);i.insertIntegral(i)}})},isNodeDragging:function(g){if(g===undefined){return this._isNodeDragging}else{if(g===true){this._isNodeDragging=true;this.$tree.disableSelection()}else{this._isNodeDragging=false;this.$tree.enableSelection()}}},generateNewId:function(){this._lastId+=1;return"g"+this._lastId}};function c(h,g){this.manager=g;this.level=h.level;this.parent=h.parent;this.name=h.name;this.type=h.type;this.id=h.id;this.insertPosition=undefined;this.movePosition=undefined;this.relatedNodeId=undefined;this._isExpanded=false;this._isLoading=false;this._isSaved=h.id===undefined?false:true;this._isSelected=false;this._isHovered=false;this._isEditable=false;this.init()}c.prototype={getPath:function(){var i=this,h=[i.name],g=i.parent;i.$node.prevAll("."+this.manager.options.classes.node).each(function(){var j=i.manager.getNode(f(this));if(j.id===g){g=j.parent;h[h.length]=j.name}});return h},getParents:function(){var g=[],i=this.parent;while(true){if(i===0){break}var h=this.manager.getNodeById(i);g.push(h);i=h.parent}return g},getIP:function(){var i=this,h="0";var g=i.getParents();g.reverse();f.each(g,function(){h+="."+this.id});h+="."+i.id;return h},getSiblings:function(){var l=this,k=[],j="."+l.manager.options.classes.node+"[data-parent='"+l.parent+"']",h=l.$node.prevAll(j);for(var g=h.length-1;g>=0;--g){k.push(l.manager.getNode(f(h[g])))}k.push(l);l.$node.nextAll(j).each(function(){k.push(l.manager.getNode(f(this)))});return k},getDescendants:function(i){var g=this,j=f.extend({},{depth:1,includeNotSaved:false,index:undefined},i),k="."+g.manager.options.classes.node,l=j.depth!==-1||isNaN(j.depth)?j.depth:Infinity,m=[];if((j.includeNotSaved===false)){k+="."+g.manager.options.classes.saved}if(l>1){g.$node.nextAll(k).each(function(){var n=g.manager.getNode(f(this));if((n.level<=g.level)||(n.level===g.level&&n.parent===g.parent)){if(!(j.includeNotSaved===true&&!n.isSaved())){return false}}m.push(n)})}else{g.$node.nextAll(k+"[data-parent='"+g.id+"'][data-level='"+(g.level+1)+"']").each(function(){m.push(g.manager.getNode(f(this)))})}if(!isNaN(j.index)){var h=j.index>=0?j.index-1:m.length+j.index;return m[h]}return m},getMovePosition:function(){return this.movePosition},setMovePosition:function(g,h){this.$node.removeClass(this.manager.options.classes.draggableContainer);if(g!==undefined){this.$node.addClass(this.manager.options.classes.draggableContainer);this.movePosition=g;this.$pointer.css("top",h.top+"px");this.$pointer.css("left",h.left+"px")}},getId:function(){return this.id},getName:function(){return this.isEditable()?this.$input.val():this.name},getParent:function(){return this.parent},getInsertPosition:function(){return this.insertPosition},getRelatedNodeId:function(){return this.relatedNodeId},init:function(){this.$node=this.manager.$nodeTemplate.clone(false);this.$name=this.$node.find("."+this.manager.options.classes.name);this.$ceIcon=this.$node.find("."+this.manager.options.classes.ceIcon);this.$typeIcon=this.$node.find("."+this.manager.options.classes.typeIcon);this.$icon=this.$node.find("."+this.manager.options.classes.icon);this.$action=this.$node.find("."+this.manager.options.classes.action);this.$indent=this.$node.find("."+this.manager.options.classes.indent);this.$saveButton=this.$node.find("."+this.manager.options.classes.saveButton);this.$cancelButton=this.$node.find("."+this.manager.options.classes.cancelButton);this.$input=this.$node.find("input");this.$pointer=this.$node.find("."+this.manager.options.classes.draggablePointer);this.render();this.attachEvents();this.$node.data("bs.gtreetable.gtreetablenode",this)},render:function(){this.$name.html(this.name);if(this.id!==undefined){this.$node.attr("data-id",this.id);this.isSaved(true);if(this.manager.options.draggable===true){this.$node.addClass(this.manager.options.classes.draggable)}}this.$node.attr("data-parent",this.parent);this.$node.attr("data-level",this.level);this.$indent.css("marginLeft",((parseInt(this.level,10)-1)*this.manager.options.nodeIndent)+"px").html("&zwnj;");if(this.type!==undefined&&this.manager.options.types&&this.manager.options.types[this.type]!==undefined){this.$typeIcon.addClass(this.manager.options.types[this.type]).show()}},attachEvents:function(){var h=this;this.$node.mouseover(function(){if(!(h.manager.options.draggable===true&&h.manager.isNodeDragging()===true)){h.$node.addClass(h.manager.options.classes.hovered);h.isHovered(true)}});this.$node.mouseleave(function(){h.$node.removeClass(h.manager.options.classes.hovered);h.isHovered(false)});this.$name.click(function(i){if(h.isSelected()){if(f.isFunction(h.manager.options.onUnselect)){h.manager.options.onUnselect(h)}h.isSelected(false)}else{var j=h.manager.getSelectedNodes();if(h.manager.options.multiselect===false){if(j.length===1){j[0].isSelected(false)}}else{if(!isNaN(h.manager.options.multiselect)&&h.manager.options.multiselect===j.length){if(f.isFunction(h.options.onSelectOverflow)){h.options.onSelectOverflow(h)}i.preventDefault()}}h.isSelected(true);if(f.isFunction(h.manager.options.onSelect)){h.manager.options.onSelect(h)}}});this.$ceIcon.click(function(i){if(!h.isExpanded()){h.expand({isAltPressed:i.altKey})}else{h.collapse()}});if(h.manager.options.dragCanExpand===true){this.$ceIcon.mouseover(function(i){if(h.manager.options.draggable===true&&h.manager.isNodeDragging()===true){if(!h.isExpanded()){h.expand()}}})}f.each(this.manager.actions,function(i,j){h.$node.find("."+h.manager.options.classes.action+"-"+i).click(function(k){j.event(h,h.manager)})});this.$saveButton.click(function(){h.save()});this.$cancelButton.click(function(){h.saveCancel()});if(h.manager.options.draggable===true){function g(o,m){var l=o.offset.top-m.offset().top,j=m.offset().top,n=m.outerHeight(),p=n-(o.helper.outerHeight()/2),i=undefined,k={left:h.manager.$tree.offset().left+5};if(l<=(p*0.3)){i="before";k.top=(j+3)}else{if(l<=(p*0.7)){i="lastChild";k.top=j+Math.round(p/2)}else{i="after";k.top=j+p}}return{position:i,pointerOffset:k}}this.$node.draggable({scroll:true,refreshPositions:h.manager.options.dragCanExpand,helper:function(j){var i=h.manager.getNode(f(this));return'<mark class="'+h.manager.options.classes.draggableHelper+'">'+i.name+"</mark>"},cursorAt:{top:0,left:0},handle:"."+h.manager.options.classes.handleIcon,start:function(i){if(!f.browser.webkit){f(this).data("bs.gtreetable.gtreetablenode.scrollTop",f(window).scrollTop())}},stop:function(i){h.manager.isNodeDragging(false)},drag:function(m,l){if(!f.browser.webkit){var i=f(window).scrollTop(),n=(f(this).data("bs.gtreetable.gtreetablenode.scrollTop")-i);l.position.top-=i+n;f(this).data("bs.gtreetable.gtreetablenode.startingScrollTop",i)}var j=f(this).data("bs.gtreetable.gtreetablenode.currentDroppable");if(j){var k=g(l,j);h.manager.getNode(j).setMovePosition(k.position,k.pointerOffset)}}}).droppable({accept:"."+h.manager.options.classes.node,over:function(i,k){var l=f(this),j=g(k,l);h.manager.getNode(l).setMovePosition(j.position,j.pointerOffset);k.draggable.data("bs.gtreetable.gtreetablenode.currentDroppable",l)},out:function(i,j){j.draggable.removeData("bs.gtreetable.gtreetablenode.currentDroppable");h.manager.getNode(f(this)).setMovePosition()},drop:function(j,k){var l=f(this),m=h.manager.getNode(l),i=m.getMovePosition();k.draggable.removeData("bs.gtreetable.gtreetablenode.currentDroppable");m.setMovePosition();h.manager.getNode(k.draggable).move(m,i)}})}},makeEditable:function(){this.showForm(true)},save:function(){var g=this;if(f.isFunction(g.manager.options.onSave)){f.when(g.manager.options.onSave(g)).done(function(h){g._save(h)})}else{g._save({name:g.getName(),id:g.manager.generateNewId()})}},_save:function(g){var h=this;h.id=g.id;h.name=g.name;if(f.isFunction(h.manager.options.sort)){h.sort()}if(this.manager.options.cache>0){this.manager.cacheManager.synchronize(h.isSaved()?"edit":"add",h)}h.render();h.showForm(false);h.isHovered(false)},saveCancel:function(){this.showForm(false);if(!this.isSaved()){this._remove()}},expand:function(h){var j=this,g=j,i=f.extend({},{isAltPressed:false,onAfterFill:function(l,k){l.isExpanded(true);if(k.length===0){if(l.manager.options.showExpandIconOnEmpty===true){l.isExpanded(false)}else{l.showCeIcon(false)}}}},h);f.when(this.manager.getSourceNodes(j.id,i.isAltPressed)).done(function(m){for(var k in m){var l=new c(m[k],j.manager);j.insertIntegral(l,g);g=l}if(i&&typeof f.isFunction(i.onAfterFill)){i.onAfterFill(j,m)}})},collapse:function(){this.isExpanded(false);f.each(this.getDescendants({depth:-1,includeNotSaved:true}),function(){this.$node.remove()})},_canAdd:function(g){var h={result:!(g.parent===0&&this.manager.options.manyroots===false)};if(!h.result){h.message=this.manager.language.messages.onNewRootNotAllowed}return h},add:function(g,m){var l=this,i=(g==="lastChild"||g==="firstChild"),k=new c({level:l.level+(i?1:0),parent:l.level===1&&!i?0:(i?l.id:l.parent),type:m},this.manager),h=this._canAdd(k);if(!h.result){alert(h.message);return false}function j(){if(i){l.isExpanded(true);l.showCeIcon(true)}k.insert(g,l);k.insertPosition=g;k.relatedNodeId=l.id;k.showForm(true)}if(i&&!l.isExpanded()){l.expand({onAfterFill:function(){j()}})}else{j()}},insert:function(g,i){var k=this;if(g==="before"){i.$node.before(k.$node)}else{if(g==="after"){var h=i;if(i.isExpanded()){var j=i.getDescendants({depth:1,index:-1,includeNotSaved:true});h=j===undefined?h:j}h.$node.after(k.$node)}else{if(g==="firstChild"){this.manager.getNodeById(i.id).$node.after(k.$node)}else{if(g==="lastChild"){var j=i.getDescendants({depth:1,index:-1,includeNotSaved:true});var h=j===undefined?i:j;h.$node.after(k.$node)}else{throw"Wrong position."}}}}},insertIntegral:function(g,h){if(h===undefined){this.manager.$tree.append(g.$node)}else{h.$node.after(g.$node)}},remove:function(){var g=this;if(g.isSaved()&&f.isFunction(g.manager.options.onDelete)){f.when(g.manager.options.onDelete(g)).done(function(){g._remove()})}else{this._remove()}},_remove:function(){if(this.isExpanded()===true){this.collapse()}this.$node.remove();if(this.parent>0){var g=this.manager.getNodeById(this.parent);if(g.getDescendants({depth:1,includeNotSaved:true}).length===0){g.collapse()}}if(this.manager.options.cache>0){this.manager.cacheManager.synchronize("delete",this)}},_canMove:function(j,g){var i=this,h={result:true};if(j.parent===0&&this.manager.options.manyroots===false&&g!=="lastChild"){h.result=false;h.message=this.manager.language.messages.onMoveAsRoot}else{f.each(j.getParents(),function(){if(this.id===i.id){h.result=false;h.message=this.manager.language.messages.onMoveInDescendant;return false}})}return h},move:function(j,g){var i=this,h=this._canMove(j,g);if(h.result===false){alert(h.message);return false}if(f.isFunction(i.manager.options.onMove)){f.when(i.manager.options.onMove(i,j,g)).done(function(k){i._move(j,g)})}else{i._move(j,g)}},_move:function(j,l){var n=this,o=n.getDescendants({depth:-1,includeNotSaved:true}),g=f.extend({},n),h=n.getIP(),m=j.level-n.level;n.parent=l==="lastChild"?j.id:j.parent;n.level=j.level;if(l==="lastChild"&&!j.isExpanded()){n.$node.remove();f.each(o,function(){this.$node.remove()})}else{if(l==="lastChild"){n.level+=1;j.showCeIcon(true)}n.render();n.insert(l,j);if(o.length>0){var i=n.$node;if(l==="lastChild"){m+=1}f.each(o,function(){var p=this;p.level+=m;p.render();i.after(p.$node);i=p.$node})}}var k=n.manager.getNodeById(g.parent);if(k!==undefined&&k.getDescendants({depth:1,includeNotSaved:true}).length===0){k.isExpanded(false)}if(f.isFunction(n.manager.options.sort)){n.sort()}if(this.manager.options.cache>0){this.manager.cacheManager.synchronize("move",n,{oOldNode:g,oldIP:h})}},sort:function(){var i=this,k=i.getSiblings();if(k.length>0){var j=!i.isExpanded()?[]:i.getDescendants({depth:-1,includeNotSaved:true}),h=undefined;f.each(k,function(){if(i.manager.options.sort(i,this)===-1){h=this;return false}});if(h===undefined){h=k[k.length-1];if(h.isExpanded()){h=i.manager.getNodeById(i.parent).getDescendants({depth:-1,index:-1,includeNotSaved:true})}h.$node.after(i.$node)}else{h.$node.before(i.$node)}var g=i.$node;f.each(j,function(){var l=this;g.after(l.$node);g=l.$node})}},isLoading:function(g){if(g===undefined){return this._isLoading}else{if(g){this.$name.addClass(this.manager.options.classes.loading);this._isLoading=true}else{this.$name.removeClass(this.manager.options.classes.loading);this._isLoading=false}}},isSaved:function(g){if(g===undefined){return this._isSaved}else{if(g){this.$node.addClass(this.manager.options.classes.saved);this._isSaved=true}else{this.$node.removeClass(this.manager.options.classes.saved);this._isSaved=false}}},isSelected:function(g){if(g===undefined){return this._isSelected}else{if(g){this.$node.addClass(this.manager.options.classes.selected);this._isSelected=true}else{this.$node.removeClass(this.manager.options.classes.selected);this._isSelected=false}}},isExpanded:function(g){if(g===undefined){return this._isExpanded}else{if(g){this.$node.addClass(this.manager.options.classes.expanded).removeClass(this.manager.options.classes.collapsed);this._isExpanded=true}else{this.$node.addClass(this.manager.options.classes.collapsed).removeClass(this.manager.options.classes.expanded);this._isExpanded=false}}},isHovered:function(g){if(g===undefined){return this._isHovered}else{if(g){this.$node.addClass(this.manager.options.classes.hovered);this._isHovered=true}else{this.$node.removeClass(this.manager.options.classes.hovered);this.$node.find(".btn-group").removeClass("open");this._isHovered=false}}},isEditable:function(g){if(g===undefined){return this._isEditable}else{this._isEditable=g}},showCeIcon:function(g){this.$ceIcon.css("visibility",g?"visible":"hidden")},showForm:function(g){if(g===true){this.isEditable(true);this.$input.val(this.name);this.$name.addClass("hide");this.$action.removeClass("hide");this.$input.focus()}else{this.isEditable(false);this.$name.removeClass("hide");this.$action.addClass("hide")}}};function e(g){this._cached={};this.manager=g}e.prototype={_getIP:function(g){return typeof g==="string"?g:g.getIP()},get:function(g){return this._cached[this._getIP(g)]},set:function(h,g){this._cached[this._getIP(h)]=g},remove:function(g){this._cached[this._getIP(g)]=undefined},synchronize:function(i,h,g){if(h.parent>0){switch(i){case"add":this._synchronizeAdd(h);break;case"edit":this._synchronizeEdit(h);break;case"delete":this._synchronizeDelete(h);break;case"move":this._synchronizeMove(h,g);break;default:throw"Wrong method.";break}}},_synchronizeAdd:function(i){var g=this.manager.getNodeById(i.parent);if(this.manager.options.cache>1){var h=this.get(g);if(h!==undefined){h.push({id:i.id,name:i.getName(),level:i.level,type:i.type,parent:i.parent});this.set(g,this.isSortDefined()?this.sort(h):h)}}else{this.remove(g)}},_synchronizeEdit:function(i){var g=this.manager.getNodeById(i.parent);if(this.manager.options.cache>1){var h=this.get(g);f.each(h,function(){if(this.id===i.id){this.name=i.getName();return false}});this.set(g,this.isSortDefined()?this.sort(h):h)}else{this.remove(g)}},_synchronizeDelete:function(j){var h=this.manager.getNodeById(j.parent);if(this.manager.options.cache>1){var i=this.get(h),g=undefined;f.each(i,function(k){if(this.id===j.id){g=k;return false}});if(g!==undefined){i.splice(g,1);this.set(h,i)}}else{this.remove(h)}},_synchronizeMove:function(j,i){var h=this,g=j.getIP(),k=j.level-i.oOldNode.level;f.each(this._cached,function(l){if(l===i.oldIP||l.indexOf(i.oldIP+".")===0){if(h.manager.options.cache>1){var n=[],m=l!==i.oldIP?g+l.substr(i.oldIP.length):g;f(h.get(l)).each(function(){this.level+=k;n.push(this)});h.set(m,n)}h.remove(l)}});this.synchronize("delete",i.oOldNode);this.synchronize("add",j)},isSortDefined:function(){return f.isFunction(this.manager.options.sort)},sort:function(g){return g.sort(this.manager.options.sort)}};function d(h,i){var g=null;this.each(function(){var l=f(this),k=l.data("bs.gtreetable"),j=f.extend({},f.fn.gtreetable.defaults,l.data(),typeof h==="object"&&h);if(!k){k=new b(this,j);l.data("bs.gtreetable",k)}if(typeof h==="string"){g=k[h](i)}});if(!g){g=this}return g}var a=f.fn.gtreetable;f.fn.gtreetable=d;f.fn.gtreetable.Constructor=b;f.fn.gtreetable.defaults={nodeIndent:16,language:"en",inputWidth:"60%",cache:2,readonly:false,multiselect:false,manyroots:false,draggable:false,dragCanExpand:false,showExpandIconOnEmpty:false,languages:{en:{save:"Save",cancel:"Cancel",action:"Action",actions:{createBefore:"Create before",createAfter:"Create after",createFirstChild:"Create first child",createLastChild:"Create last child",update:"Update","delete":"Delete"},messages:{onDelete:"Are you sure?",onNewRootNotAllowed:"Adding the now node as root is not allowed.",onMoveInDescendant:"The target node should not be descendant.",onMoveAsRoot:"The target node should not be root."}}},defaultActions:[{name:"{createBefore}",event:function(h,g){h.add("before","default")}},{name:"{createAfter}",event:function(h,g){h.add("after","default")}},{name:"{createFirstChild}",event:function(h,g){h.add("firstChild","default")}},{name:"{createLastChild}",event:function(h,g){h.add("lastChild","default")}},{divider:true},{name:"{update}",event:function(h,g){h.makeEditable()}},{name:"{delete}",event:function(h,g){if(confirm(g.language.messages.onDelete)){h.remove()}}}],classes:{node:"node",loading:"node-loading",selected:"node-selected",hovered:"node-hovered",expanded:"node-expanded",collapsed:"node-collapsed",draggable:"node-draggable",draggableHelper:"node-draggable-helper",draggablePointer:"node-draggable-pointer",draggableContainer:"node-draggable-container",saved:"node-saved",name:"node-name",icon:"node-icon",selectedIcon:"node-icon-selected",ceIcon:"node-icon-ce",typeIcon:"node-icon-type",handleIcon:"node-icon-handle",action:"node-action",indent:"node-indent",saveButton:"node-save",cancelButton:"node-cancel"}};f.fn.gtreetable.noConflict=function(){f.fn.gtreetable=a;return this}}(jQuery));